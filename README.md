# ğŸ¦€ Ritcher

## Rust-based HLS Stitcher for Server-Side Ad Insertion (SSAI)

Ritcher is a high-performance HLS stitcher built in Rust that enables seamless server-side ad insertion in live and VOD streams.

---

## âœ¨ Current Features

- âš¡ **HLS Playlist Parsing** - Full support for media playlists using m3u8-rs
- ğŸ”„ **URL Rewriting** - Dynamic segment URL modification for stitching
- ğŸš€ **Segment Proxying** - High-performance video segment delivery
- ğŸ’¾ **Session Management** - Per-session origin URL tracking
- ğŸ”§ **Environment-Based Config** - DEV/PROD mode with flexible configuration
- ğŸ“Š **Structured Logging** - Comprehensive tracing with tracing-subscriber
- ğŸ›¡ï¸ **Production-Ready Error Handling** - Graceful error responses

---

## ğŸ—ï¸ Architecture

```bash
Player Request â†’ Ritcher â†’ Modified HLS Playlist
                   â†“
          [Origin CDN + Proxying]
```

### How It Works

1. **Player requests playlist** with origin URL parameter
2. **Ritcher fetches** original playlist from origin CDN
3. **Parser modifies** segment URLs to route through Ritcher
4. **Player requests segments** through Ritcher
5. **Ritcher proxies** segments from origin to player

---

## ğŸš€ Getting Started

### Prerequisites

- Rust 1.70+ (uses 2024 edition)
- Cargo

### Installation

```bash
# Clone the repository
git clone https://github.com/JoeldelPilar/ritcher.git
cd ritcher

# Build
cargo build --release
```

### Running in Development

```bash
# Start server with default dev config
DEV_MODE=true cargo run

# Custom port
DEV_MODE=true PORT=8080 cargo run

# Custom base URL
DEV_MODE=true BASE_URL=http://localhost:8080 cargo run
```

### Running in Production

```bash
# All env vars required in production
PORT=3000 \
BASE_URL=https://stitcher.example.com \
ORIGIN_URL=https://cdn.example.com \
cargo run --release
```

---

## ğŸ“¡ API Endpoints

### Health Check

```bash
GET /health
```

### Serve Modified Playlist

```bash
GET /stitch/{session_id}/playlist.m3u8?origin={origin_playlist_url}
```

**Example:**

```bash
curl "http://localhost:3000/stitch/abc123/playlist.m3u8?origin=https://test-streams.mux.dev/x36xhzz/url_0/193039199_mp4_h264_aac_hd_7.m3u8"
```

### Proxy Video Segment

```bash
GET /stitch/{session_id}/segment/*segment_path?origin={origin_base_url}
```

**Note:** Segment requests are automatically generated by the player from the modified playlist.

---

## ğŸ› ï¸ Tech Stack

- **Language:** Rust ğŸ¦€ (Edition 2024)
- **HTTP Server:** Axum 0.8
- **Async Runtime:** Tokio 1.42
- **HLS Parser:** m3u8-rs 6.0
- **HTTP Client:** reqwest 0.12
- **Logging:** tracing + tracing-subscriber
- **Serialization:** serde + serde_json

---

## âš™ï¸ Configuration

### Environment Variables

| Variable | Description | Required | Default (DEV mode) |
|----------|-------------|----------|-------------------|
| `DEV_MODE` | Enable development mode | No | `false` |
| `PORT` | Server port | Production only | `3000` |
| `BASE_URL` | Stitcher's public URL | Production only | `http://localhost:3000` |
| `ORIGIN_URL` | Default origin CDN URL | Production only | `https://example.com` |

---

## ğŸ§ª Testing with Real Streams

### Using Mux Test Streams

```bash
# Start server
DEV_MODE=true cargo run

# Request modified playlist
curl "http://localhost:3000/stitch/test123/playlist.m3u8?origin=https://test-streams.mux.dev/x36xhzz/url_0/193039199_mp4_h264_aac_hd_7.m3u8"

# Download a segment
curl "http://localhost:3000/stitch/test123/segment/url_462/193039199_mp4_h264_aac_hd_7.ts?origin=https://test-streams.mux.dev/x36xhzz/url_0" -o test.ts

# Verify segment
ffprobe test.ts
```

---

## ğŸ“‹ Roadmap

### Phase 1: Foundation âœ…

- [x] Project setup & HTTP server
- [x] HLS playlist parsing
- [x] Basic URL rewriting
- [x] Segment proxying
- [x] Environment-based config

### Phase 2: Ad Insertion (In Progress)

- [ ] Ad decision logic
- [ ] Ad segment serving
- [ ] Discontinuity tag handling
- [ ] SCTE-35 marker support

### Phase 3: Production Hardening

- [ ] Session state management with cleanup
- [ ] Master playlist support
- [ ] Metrics & monitoring
- [ ] Rate limiting
- [ ] Caching layer

### Phase 4: Deployment

- [ ] Docker support
- [ ] Kubernetes manifests
- [ ] Performance benchmarks
- [ ] Load testing

---

## ğŸš§ Current Status

**Early Development** - Core functionality working, ad insertion in progress.

The stitcher can currently:

- âœ… Fetch and parse HLS playlists from any origin
- âœ… Rewrite segment URLs to route through Ritcher
- âœ… Proxy video segments with full quality preservation
- â³ Insert ads (coming next!)

---

## ğŸ‘¨â€ğŸ’» Author

**Joel del Pilar** ([@JoeldelPilar](https://github.com/JoeldelPilar))

Built as a learning project exploring Rust for high-performance video streaming.

---

## ğŸ™ Inspiration

Inspired by [Eyevinn Technology](https://www.eyevinntechnology.se/)'s work in video streaming and open-source contributions to the streaming community.

---

## ğŸ“„ License

MIT License - see [LICENSE](LICENCE) file for details

---

## ğŸ”— Resources

- [HLS Specification](https://datatracker.ietf.org/doc/html/rfc8216)
- [Rust Async Book](https://rust-lang.github.io/async-book/)
- [Axum Documentation](https://docs.rs/axum)
- [m3u8-rs Documentation](https://docs.rs/m3u8-rs)
